services:
  kakao-preprocess:
    build:
      context: ./Preprocessing
    container_name: kakao-preprocessor
    # ✅ 변경 1: condition 제거 (Qdrant는 시작만 하면 됨)
    depends_on:
      - qdrant
    volumes:
      - ./Preprocessing:/app
      - ./Preprocessing/kakao_data:/app/kakao_data
      - ./Preprocessing/processed_data:/app/processed_data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MAIN_SENDER=${MAIN_SENDER}
    networks:
      - mychat-network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    volumes:
      - qdrant_storage:/qdrant/storage
    restart: unless-stopped
    # ✅ 변경 2: healthcheck 삭제 (Qdrant 이미지에 curl이 없을 수 있음)
    # healthcheck: ... 삭제됨
    networks:
      - mychat-network

  fastapi:
    build:
      context: ./BE
    container_name: fastapi
    # ✅ 변경 3: Qdrant는 그냥 기다리고, MySQL만 'healthy' 상태 기다림
    depends_on:
      qdrant:
        condition: service_started
      mysql:
        condition: service_healthy
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./BE:/app
    command: >
      uvicorn app.main:app
      --host 0.0.0.0
      --port 8000
      --reload
      --reload-dir /app
      --reload-include *.py
      --reload-include *.yaml
      --reload-include *.yml
      --reload-include *.json
    networks:
      - mychat-network

  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    # MySQL은 초기화가 오래 걸리므로 healthcheck 유지
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mychat-network

  nginx:
    build:
      context: .
      dockerfile: ./nginx/Dockerfile
    container_name: nginx
    ports:
      - "80:80"
    depends_on:
      - fastapi
    networks:
      - mychat-network

volumes:
  qdrant_storage:
  mysql_data:

networks:
  mychat-network:
    driver: bridge